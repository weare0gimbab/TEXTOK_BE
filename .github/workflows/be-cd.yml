name: backend-ci-cd

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: weare0gimbab/textok-backend

jobs:
  build-test-push-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout
      - name: Checkout source
        uses: actions/checkout@v4

      # 2) Login to GHCR
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_TOKEN }}

      # 3) Setup JDK
      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 4) Gradle permission
      - name: Grant execute permission to Gradle wrapper
        run: chmod +x ./gradlew

      # 5) Build JAR
      - name: Build Spring Boot JAR
        run: ./gradlew clean bootJar --no-daemon

      # 6) Build Docker Image
      - name: Build Docker image
        run: |
          docker build \
            -t $REGISTRY/$IMAGE_NAME:latest \
            .

      # 7) Push Docker Image
      - name: Push Docker image
        run: |
          docker push $REGISTRY/$IMAGE_NAME:latest

      # 8) SSH Key ì„¤ì •
      - name: Setup SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > private_key.pem
          chmod 600 private_key.pem

      # 9) Deploy to EC2
      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_PUBLIC_IP }} "
            cd /home/ec2-user/app && \
            echo 'ðŸ“¦ Pulling latest image...' && \
            docker pull ghcr.io/${{ secrets.GHCR_OWNER }}/aibe3-finalproject-team4-backend:latest && \
            echo 'ðŸš€ Running deploy.sh...' && \
            bash deploy.sh
          "

      # 10) Done
      - name: Deployment completed
        run: echo "ðŸŽ‰ Backend CD (Build â†’ Push â†’ Deploy) finished successfully!"
